<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest Board - Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <link rel="stylesheet" href="../css/style.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap');
        body { font-family: 'Poppins', system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; }
        
        .description-truncate {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .nav-card {
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
            border: 2px solid transparent;
        }
        .nav-card:hover { transform: translateY(-4px); }
        .nav-card.active {
            border-color: rgba(0,0,0,0.05);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), inset 0 0 0 2px rgba(255,255,255,0.5);
            ring: 2px;
        }

        .icon-box {
            background: rgba(255, 255, 255, 0.6);
            backdrop-filter: blur(4px);
        }
        
        .tag-selector {
            position: relative;
            width: 100%;
        }
        .tag-selector-control {
            display: flex;
            align-items: center;
            min-height: 34px;
            border-radius: 8px;
            padding: 4px 10px;
            border: 1px solid #e5e7eb;
            background: #f9fafb;
            cursor: text;
            width: 100%;
            gap: 6px;
        }
        .tag-selector-control:hover {
            background: #f3f4f6;
        }
        .tag-selected-list {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            flex: 1;
        }
        .tag-placeholder {
            color: #9ca3af;
            font-size: 0.75rem;
        }
        .tag-pill {
            display: inline-flex;
            align-items: center;
            padding: 2px 8px;
            border-radius: 999px;
            font-size: 0.75rem;
            background: #e5e7eb;
            color: #111827;
        }
        .tag-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            margin-top: 4px;
            background: #ffffff;
            border-radius: 12px;
            border: 1px solid #e5e7eb;
            box-shadow: 0 18px 45px rgba(15, 23, 42, 0.15);
            padding: 6px 0 4px 0;
            z-index: 40;
            display: none;
        }
        .tag-search-input {
            width: 100%;
            border: none;
            outline: none;
            padding: 6px 12px 8px 12px;
            font-size: 0.85rem;
        }
        .tag-options {
            max-height: 220px;
            overflow-y: auto;
            padding: 0 4px 4px 4px;
        }
        .tag-option {
            display: flex;
            align-items: center;
            padding: 4px 8px;
            cursor: pointer;
            gap: 6px;
        }
        .tag-option:hover {
            background: #f3f4f6;
        }
        .tag-option-selected .tag-pill {
            background: #4338ca;
            color: #eef2ff;
        }
        .tag-create {
            display: flex;
            align-items: center;
            padding: 6px 12px 8px 12px;
            border-top: 1px solid #e5e7eb;
            font-size: 0.8rem;
            color: #6b7280;
            cursor: pointer;
        }
        .tag-create:hover {
            background: #f3f4f6;
        }
        .tag-create-label {
            margin-left: 4px;
            padding: 2px 6px;
            border-radius: 999px;
            background: #e0e7ff;
            color: #4338ca;
        }
        .tag-remove {
            margin-left: 4px;
            cursor: pointer;
            font-size: 0.7rem;
            color: #6b7280;
        }
        .tag-remove:hover {
            color: #111827;
        }
        .rich-editor {
            position: relative;
            background: #ffffff;
        }
        .rich-toolbar {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 6px 8px;
            background: #f9fafb;
            border-bottom: 1px solid #e5e7eb;
        }
        .rich-btn {
            border: none;
            background: transparent;
            padding: 4px 8px;
            border-radius: 999px;
            font-size: 0.8rem;
            color: #4b5563;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        .rich-btn:hover {
            background: #e5e7eb;
            color: #111827;
        }
        .rich-editor-body {
            min-height: 120px;
            padding: 10px 14px;
            font-size: 0.9rem;
            outline: none;
        }
        .rich-editor-body:empty:before {
            content: attr(data-placeholder);
            color: #9ca3af;
        }
    </style>
</head>
<body class="min-h-screen p-6 md:p-12" style="background: #fff;">

    <div class="max-w-4xl mx-auto">
        
        <div class="flex justify-between items-center mb-6">
            <h1 class="text-4xl font-extrabold tracking-tight">Quest Board</h1>
            <div class="flex items-center gap-3">
                <div class="relative">
                    <button id="questHeaderToggleButton" type="button"
                        class="w-9 h-9 flex items-center justify-center rounded-full border border-gray-200 bg-white shadow-sm"
                        onclick="toggleQuestHeaderMenu(event)">
                        <i data-lucide="more-vertical" class="w-4 h-4 text-gray-600"></i>
                    </button>
                    <div id="questHeaderMenu"
                        class="absolute right-0 mt-2 w-32 bg-white border border-gray-200 rounded-xl shadow-lg py-1 text-sm text-gray-700 hidden z-40">
                        <button type="button" class="w-full text-left px-3 py-1.5 hover:bg-gray-100"
                            onclick="questHeaderEdit()">
                            Edit
                        </button>
                        <button type="button" class="w-full text-left px-3 py-1.5 hover:bg-gray-100 text-red-600"
                            onclick="questHeaderDelete()">
                            Delete
                        </button>
                    </div>
                </div>
                <button class="btn-dlg-yellow rounded-full px-6 py-2.5 text-sm font-semibold shadow-md"
                    onclick="toggleQuestForm()">
                    + Create
                </button>
                <button class="btn-dlg-red rounded-full px-5 py-2 text-sm font-semibold shadow-md"
                    onclick="if (window.parent && window.parent.closeQuestBoardModal) { window.parent.closeQuestBoardModal(); }">
                    X
                </button>
            </div>
        </div>

        <div id="questCreateForm" class="mb-10 rounded-3xl border border-gray-200 bg-white shadow-sm p-6 md:p-8 hidden">
            <div class="mb-6">
                <input id="questNameInput" type="text" placeholder="Quest Name"
                    class="w-full text-2xl md:text-3xl font-semibold text-gray-900 border-none focus:ring-0 focus:outline-none placeholder-gray-400" />
            </div>
            <div class="grid md:grid-cols-2 gap-6 mb-6">
                <div class="space-y-4 text-sm">
                    <div class="flex items-center gap-3">
                        <div class="font-medium text-gray-500 w-24">Department</div>
                        <div class="flex-1">
                            <div class="relative">
                                <button type="button"
                                    class="w-full flex items-center justify-between rounded-xl border border-gray-200 bg-gray-50 px-3 py-2 text-left text-gray-700"
                                    onclick="document.getElementById('questDepartmentDropdown').classList.toggle('hidden')">
                                    <span class="flex items-center gap-2">
                                        <span class="inline-flex items-center justify-center w-6 h-6 rounded-full bg-gray-200">
                                            <span class="text-xs font-semibold text-gray-500">D</span>
                                        </span>
                                        <span id="questDepartmentButtonLabel" class="text-xs md:text-sm">Select departments...</span>
                                    </span>
                                    <span class="text-gray-400 text-xs md:text-sm">&#9662;</span>
                                </button>
                                <div id="questDepartmentDropdown"
                                    class="absolute top-full left-0 right-0 mt-2 rounded-xl border border-gray-200 bg-white shadow-lg p-3 hidden max-h-60 overflow-y-auto text-xs md:text-sm z-20">
                                    <span class="text-gray-400 text-xs">Loading departments...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="flex items-center gap-3">
                        <div class="font-medium text-gray-500 w-24">Assign to</div>
                        <div class="flex-1">
                            <div class="relative">
                                <button type="button"
                                    class="w-full flex items-center justify-between rounded-xl border border-gray-200 bg-gray-50 px-3 py-2 text-left text-gray-700"
                                    onclick="document.getElementById('questAssignDropdown').classList.toggle('hidden')">
                                    <span class="flex items-center gap-2">
                                        <span id="questAssignAvatars" class="flex -space-x-1"></span>
                                        <span id="questAssignButtonLabel" class="text-xs md:text-sm">Select user...</span>
                                    </span>
                                    <span class="text-gray-400 text-xs md:text-sm">&#9662;</span>
                                </button>
                                <div id="questAssignDropdown"
                                    class="absolute top-full left-0 mt-2 w-72 md:w-80 rounded-2xl bg-slate-900 text-white shadow-2xl p-3 hidden text-xs md:text-sm z-40">
                                    <div class="mb-3">
                                        <div class="relative">
                                            <span class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 text-sm">
                                                &#128269;
                                            </span>
                                            <input id="questAssignSearch" type="text"
                                                class="w-full rounded-full bg-slate-800 text-xs md:text-sm text-white placeholder-slate-500 pl-8 pr-3 py-1.5 outline-none border border-slate-700 focus:border-sky-500 focus:ring-0"
                                                placeholder="Search..." />
                                        </div>
                                    </div>
                                    <div class="text-[10px] tracking-[0.18em] text-slate-400 font-semibold mb-2">
                                        PEOPLE
                                    </div>
                                    <div id="questAssignList" class="max-h-56 overflow-y-auto flex flex-col gap-1">
                                        <div class="text-slate-500 text-xs">Loading users...</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="flex items-center gap-3">
                        <div class="font-medium text-gray-500 w-24">Dates</div>
                        <div class="flex-1 flex flex-wrap items-center gap-2">
                            <div class="relative">
                                <input id="questDueDate" type="text" placeholder="dd/mm/yyyy"
                                    class="w-28 md:w-32 rounded-xl border border-gray-200 px-3 py-2 text-xs md:text-sm text-gray-700 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-100"
                                    onclick="toggleQuestDueDropdown()" />
                                <div id="questDueDropdown"
                                    class="absolute left-0 mt-2 w-[420px] md:w-[460px] rounded-2xl bg-white border border-gray-200 shadow-2xl p-4 text-xs md:text-sm text-gray-800 hidden z-30">
                                    <div class="flex gap-4">
                                        <div class="w-40 md:w-44 border-r border-gray-100 pr-4">
                                            <div class="font-semibold text-sm mb-2">Due date</div>
                                            <div class="flex flex-col gap-1">
                                                <button type="button" class="flex items-center justify-between px-2 py-1.5 rounded-lg hover:bg-gray-50"
                                                    onclick="questDueQuickSelect('today')">
                                                    <span>Today</span>
                                                </button>
                                                <button type="button" class="flex items-center justify-between px-2 py-1.5 rounded-lg hover:bg-gray-50"
                                                    onclick="questDueQuickSelect('later')">
                                                    <span>Later</span>
                                                </button>
                                                <button type="button" class="flex items-center justify-between px-2 py-1.5 rounded-lg hover:bg-gray-50"
                                                    onclick="questDueQuickSelect('tomorrow')">
                                                    <span>Tomorrow</span>
                                                </button>
                                                <button type="button" class="flex items-center justify-between px-2 py-1.5 rounded-lg hover:bg-gray-50"
                                                    onclick="questDueQuickSelect('this-weekend')">
                                                    <span>This weekend</span>
                                                </button>
                                                <button type="button" class="flex items-center justify-between px-2 py-1.5 rounded-lg hover:bg-gray-50"
                                                    onclick="questDueQuickSelect('next-week')">
                                                    <span>Next week</span>
                                                </button>
                                                <button type="button" class="flex items-center justify-between px-2 py-1.5 rounded-lg hover:bg-gray-50"
                                                    onclick="questDueQuickSelect('next-weekend')">
                                                    <span>Next weekend</span>
                                                </button>
                                                <button type="button" class="flex items-center justify-between px-2 py-1.5 rounded-lg hover:bg-gray-50"
                                                    onclick="questDueQuickSelect('two-weeks')">
                                                    <span>2 weeks</span>
                                                </button>
                                                <button type="button" class="flex items-center justify-between px-2 py-1.5 rounded-lg hover:bg-gray-50"
                                                    onclick="questDueQuickSelect('four-weeks')">
                                                    <span>4 weeks</span>
                                                </button>
                                            </div>
                                        </div>
                                        <div class="flex-1 pl-2">
                                            <div class="flex items-center justify-between mb-2">
                                                <button type="button"
                                                    class="text-[11px] text-gray-500 hover:text-gray-700"
                                                    onclick="questDueGoToday()">
                                                    Today
                                                </button>
                                                <div class="flex items-center gap-1">
                                                    <button type="button"
                                                        class="p-1 text-gray-400 hover:text-gray-600"
                                                        onclick="questDueChangeMonth(-1)">
                                                        &#10094;
                                                    </button>
                                                    <div id="questDueMonthLabel"
                                                        class="text-[11px] font-semibold text-gray-700 min-w-[90px] text-center">
                                                    </div>
                                                    <button type="button"
                                                        class="p-1 text-gray-400 hover:text-gray-600"
                                                        onclick="questDueChangeMonth(1)">
                                                        &#10095;
                                                    </button>
                                                </div>
                                            </div>
                                            <div class="grid grid-cols-7 gap-1 text-[10px] text-gray-400 mb-1">
                                                <div class="text-center">Su</div>
                                                <div class="text-center">Mo</div>
                                                <div class="text-center">Tu</div>
                                                <div class="text-center">We</div>
                                                <div class="text-center">Th</div>
                                                <div class="text-center">Fr</div>
                                                <div class="text-center">Sa</div>
                                            </div>
                                            <div id="questDueCalendarGrid"
                                                class="grid grid-cols-7 gap-1 text-[11px] text-gray-500">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="relative">
                                <button type="button"
                                    class="inline-flex items-center gap-1 rounded-full border border-gray-200 px-3 py-1.5 text-xs md:text-sm font-medium text-gray-700 bg-white"
                                    onclick="toggleQuestRecurDropdown()">
                                    <span class="w-3 h-3 rounded-full border border-gray-400 flex items-center justify-center text-[8px] text-gray-500">&#8635;</span>
                                    <span>Recur</span>
                                </button>
                                <div id="questRecurDropdown"
                                    class="absolute right-0 mt-2 w-[420px] md:w-[460px] rounded-2xl bg-white border border-gray-200 shadow-2xl p-4 text-xs md:text-sm text-gray-800 hidden z-30">
                                    <div class="flex gap-4">
                                        <div class="flex-1">
                                            <div class="flex items-center justify-between mb-3">
                                                <div class="font-semibold text-sm">Recurring</div>
                                                <button type="button" class="text-gray-400 text-lg leading-none"
                                                    onclick="document.getElementById('questRecurDropdown').classList.add('hidden')">
                                                    &times;
                                                </button>
                                            </div>
                                            <div class="space-y-3">
                                                <div>
                                                    <label class="block text-[10px] uppercase tracking-[0.16em] text-gray-400 mb-1">Pattern</label>
                                                    <select id="questRecurPattern"
                                                        class="w-full rounded-lg border border-gray-200 px-2 py-1.5 text-xs md:text-sm text-gray-800 bg-white"
                                                        onchange="questRecurApplyPattern()">
                                                        <option value="weekly">Weekly</option>
                                                        <option value="daily">Daily</option>
                                                        <option value="monthly">Monthly</option>
                                                        <option value="yearly">Yearly</option>
                                                    </select>
                                                </div>
                                                <div class="flex items-center gap-2">
                                                    <span class="text-gray-500">Every</span>
                                                    <input id="questRecurIntervalInput" type="number" min="1" value="1"
                                                        class="w-14 rounded-lg border border-gray-200 px-2 py-1.5 text-xs md:text-sm text-gray-800 focus:outline-none focus:ring-2 focus:ring-blue-100"
                                                        oninput="questRecurUpdateInterval()" />
                                                    <select id="questRecurUnitSelect"
                                                        class="flex-1 rounded-lg border border-gray-200 px-2 py-1.5 text-xs md:text-sm text-gray-800 bg-white"
                                                        onchange="questRecurUpdateUnit()">
                                                        <option value="day">day</option>
                                                        <option value="week" selected>week</option>
                                                        <option value="month">month</option>
                                                        <option value="year">year</option>
                                                    </select>
                                                </div>
                                                <div>
                                                    <div class="text-[10px] uppercase tracking-[0.16em] text-gray-400 mb-1">Repeat on</div>
                                                    <div class="grid grid-cols-7 gap-1">
                                                        <button type="button" data-day="0"
                                                            class="quest-recur-day px-1.5 py-1 rounded-md text-[10px] font-medium"
                                                            onclick="questRecurToggleWeekday(0)">Su</button>
                                                        <button type="button" data-day="1"
                                                            class="quest-recur-day px-1.5 py-1 rounded-md text-[10px] font-medium"
                                                            onclick="questRecurToggleWeekday(1)">Mo</button>
                                                        <button type="button" data-day="2"
                                                            class="quest-recur-day px-1.5 py-1 rounded-md text-[10px] font-medium"
                                                            onclick="questRecurToggleWeekday(2)">Tu</button>
                                                        <button type="button" data-day="3"
                                                            class="quest-recur-day px-1.5 py-1 rounded-md text-[10px] font-medium"
                                                            onclick="questRecurToggleWeekday(3)">We</button>
                                                        <button type="button" data-day="4"
                                                            class="quest-recur-day px-1.5 py-1 rounded-md text-[10px] font-medium"
                                                            onclick="questRecurToggleWeekday(4)">Th</button>
                                                        <button type="button" data-day="5"
                                                            class="quest-recur-day px-1.5 py-1 rounded-md text-[10px] font-medium"
                                                            onclick="questRecurToggleWeekday(5)">Fr</button>
                                                        <button type="button" data-day="6"
                                                            class="quest-recur-day px-1.5 py-1 rounded-md text-[10px] font-medium"
                                                            onclick="questRecurToggleWeekday(6)">Sa</button>
                                                    </div>
                                                </div>
                                                <div id="questRecurMonthlyModeWrapper" class="mt-2 hidden">
                                                    <div class="text-[10px] uppercase tracking-[0.16em] text-gray-400 mb-1">Monthly pattern</div>
                                                    <select id="questRecurMonthlyMode"
                                                        class="w-full rounded-lg border border-gray-200 px-2 py-1.5 text-xs md:text-sm text-gray-800 bg-white"
                                                        onchange="questRecurUpdateMonthlyMode()">
                                                        <option value="same-day">Same day each month</option>
                                                        <option value="first-day">First day of the month</option>
                                                        <option value="last-day">Last day of the month</option>
                                                    </select>
                                                </div>
                                            </div>
                                            <div class="flex items-center justify-between mt-4">
                                                <div class="flex items-center gap-2">
                                                    <button type="button"
                                                        class="rounded-full px-4 py-1.5 text-xs md:text-sm font-semibold text-gray-600 bg-white border border-gray-200"
                                                        onclick="questRecurCancel()">
                                                        Cancel
                                                    </button>
                                                    <button type="button"
                                                        class="rounded-full px-4 py-1.5 text-xs md:text-sm font-semibold text-white"
                                                        style="background: radial-gradient(circle at 0% 0%, #a855f7 0%, #1d4ed8 60%, #0f172a 100%);"
                                                        onclick="questRecurSave()">
                                                        Save
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="w-48 md:w-56 border-l border-gray-100 pl-4">
                                            <div class="flex items-center justify-between mb-2">
                                                <button type="button"
                                                    class="text-[11px] text-gray-500 hover:text-gray-700"
                                                    onclick="questRecurGoToday()">
                                                    Today
                                                </button>
                                                <div class="flex items-center gap-1">
                                                    <button type="button"
                                                        class="p-1 text-gray-400 hover:text-gray-600"
                                                        onclick="questRecurChangeMonth(-1)">
                                                        &#10094;
                                                    </button>
                                                    <div id="questRecurMonthLabel"
                                                        class="text-[11px] font-semibold text-gray-700 min-w-[90px] text-center">
                                                    </div>
                                                    <button type="button"
                                                        class="p-1 text-gray-400 hover:text-gray-600"
                                                        onclick="questRecurChangeMonth(1)">
                                                        &#10095;
                                                    </button>
                                                </div>
                                            </div>
                                            <div class="grid grid-cols-7 gap-1 text-[10px] text-gray-400 mb-1">
                                                <div class="text-center">Su</div>
                                                <div class="text-center">Mo</div>
                                                <div class="text-center">Tu</div>
                                                <div class="text-center">We</div>
                                                <div class="text-center">Th</div>
                                                <div class="text-center">Fr</div>
                                                <div class="text-center">Sa</div>
                                            </div>
                                            <div id="questRecurCalendarGrid"
                                                class="grid grid-cols-7 gap-1 text-[11px] text-gray-500">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="flex items-center gap-3">
                        <div class="font-medium text-gray-500 w-24">Reminder</div>
                        <div class="flex-1">
                            <div class="relative">
                                <button type="button"
                                    class="w-full flex items-center justify-between rounded-xl border border-gray-200 bg-gray-50 px-3 py-2 text-left text-gray-700"
                                    onclick="toggleQuestReminderDropdown()">
                                    <span id="questReminderButtonLabel" class="text-xs md:text-sm">No reminder</span>
                                    <span class="text-gray-400 text-xs md:text-sm">&#9662;</span>
                                </button>
                                <div id="questReminderDropdown"
                                    class="absolute left-0 mt-2 w-[420px] md:w-[460px] rounded-2xl bg-white border border-gray-200 shadow-2xl p-4 text-xs md:text-sm text-gray-800 hidden z-30">
                                    <div class="flex gap-4">
                                        <div class="w-40 md:w-44 border-r border-gray-100 pr-4">
                                            <div class="font-semibold text-sm mb-2">Reminder</div>
                                            <div class="flex flex-col gap-1">
                                                <button type="button" class="flex items-center justify-between px-2 py-1.5 rounded-lg hover:bg-gray-50"
                                                    onclick="questReminderQuickSelect('day-before')">
                                                    <span>A Day Before</span>
                                                </button>
                                                <button type="button" class="flex items-center justify-between px-2 py-1.5 rounded-lg hover:bg-gray-50"
                                                    onclick="questReminderQuickSelect('two-days-before')">
                                                    <span>Two Days Before</span>
                                                </button>
                                                <button type="button" class="flex items-center justify-between px-2 py-1.5 rounded-lg hover:bg-gray-50"
                                                    onclick="questReminderQuickSelect('three-days-before')">
                                                    <span>Three Days Before</span>
                                                </button>
                                                <button type="button" class="flex items-center justify-between px-2 py-1.5 rounded-lg hover:bg-gray-50"
                                                    onclick="questReminderQuickSelect('weekend-before')">
                                                    <span>At Weekend Before</span>
                                                </button>
                                                <button type="button" class="flex items-center justify-between px-2 py-1.5 rounded-lg hover:bg-gray-50"
                                                    onclick="questReminderQuickSelect('everyday-before')">
                                                    <span>Everyday Before</span>
                                                </button>
                                                <hr/>
                                                <button type="button" class="flex items-center justify-between px-2 py-1.5 rounded-lg hover:bg-gray-50"
                                                    onclick="questReminderQuickSelect('early-month')">
                                                    <span>Early Day in Every Month</span>
                                                </button>
                                                <button type="button" class="flex items-center justify-between px-2 py-1.5 rounded-lg hover:bg-gray-50"
                                                    onclick="questReminderQuickSelect('final-month')">
                                                    <span>Final Day in Every Month</span>
                                                </button>
                                            </div>
                                        </div>
                                        <div class="flex-1 pl-2">
                                            <div class="flex items-center justify-between mb-2">
                                                <div id="questReminderSummary"
                                                    class="text-[11px] text-gray-500">
                                                </div>
                                                <div class="flex items-center gap-1">
                                                    <button type="button"
                                                        class="p-1 text-gray-400 hover:text-gray-600"
                                                        onclick="questReminderChangeMonth(-1)">
                                                        &#10094;
                                                    </button>
                                                    <div id="questReminderMonthLabel"
                                                        class="text-[11px] font-semibold text-gray-700 min-w-[90px] text-center">
                                                    </div>
                                                    <button type="button"
                                                        class="p-1 text-gray-400 hover:text-gray-600"
                                                        onclick="questReminderChangeMonth(1)">
                                                        &#10095;
                                                    </button>
                                                </div>
                                            </div>
                                            <div class="grid grid-cols-7 gap-1 text-[10px] text-gray-400 mb-1">
                                                <div class="text-center">Su</div>
                                                <div class="text-center">Mo</div>
                                                <div class="text-center">Tu</div>
                                                <div class="text-center">We</div>
                                                <div class="text-center">Th</div>
                                                <div class="text-center">Fr</div>
                                                <div class="text-center">Sa</div>
                                            </div>
                                            <div id="questReminderCalendarGrid"
                                                class="grid grid-cols-7 gap-1 text-[11px] text-gray-500">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="space-y-4 text-sm">
                    <div class="flex items-center gap-3">
                        <div class="font-medium text-gray-500 w-24">Positions</div>
                        <div class="flex-1">
                            <div class="relative">
                                <button type="button"
                                    class="w-full flex items-center justify-between rounded-xl border border-gray-200 bg-gray-50 px-3 py-2 text-left text-gray-700"
                                    onclick="document.getElementById('questPositionDropdown').classList.toggle('hidden')">
                                    <span id="questPositionButtonLabel" class="text-xs md:text-sm">Select positions...</span>
                                    <span class="text-gray-400 text-xs md:text-sm">&#9662;</span>
                                </button>
                                <div id="questPositionDropdown"
                                    class="absolute top-full left-0 right-0 mt-2 rounded-xl border border-gray-200 bg-white shadow-lg p-3 hidden max-h-60 overflow-y-auto text-xs md:text-sm z-20">
                                    <span class="text-gray-400 text-xs">Loading positions...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="flex items-center gap-3">
                        <div class="font-medium text-gray-500 w-24">Notify to</div>
                        <div class="flex-1">
                            <div class="relative">
                                <button type="button"
                                    class="w-full flex items-center justify-between rounded-xl border border-gray-200 bg-gray-50 px-3 py-2 text-left text-gray-700"
                                    onclick="toggleQuestNotifyDropdown()">
                                    <span id="questNotifyButtonLabel" class="text-xs md:text-sm">Select people...</span>
                                    <span class="text-gray-400 text-xs md:text-sm">&#9662;</span>
                                </button>
                                <div id="questNotifyDropdown"
                                    class="absolute top-full left-0 right-0 mt-2 rounded-2xl border border-gray-200 bg-white shadow-lg p-3 hidden max-h-60 overflow-y-auto text-xs md:text-sm z-30">
                                    <span class="text-gray-400 text-xs">Loading people...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="flex items-center gap-3">
                        <div class="font-medium text-gray-500 w-24">Task Point</div>
                        <div class="flex-1">
                            <input id="questPointInput" type="number" min="0" step="1"
                                class="w-24 rounded-xl border border-gray-200 px-3 py-2 text-xs md:text-sm text-gray-700 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-100"
                                placeholder="XP" />
                        </div>
                    </div>
                    <div class="flex items-center gap-3">
                        <div class="font-medium text-gray-500 w-24">Tags</div>
                        <div class="flex-1">
                            <div class="tag-selector" id="questTagSelector">
                                <div class="tag-selector-control" onclick="questTagFocusSearch()">
                                    <div class="tag-selected-list" id="questTagSelectedList"></div>
                                    <span id="questTagPlaceholder" class="tag-placeholder">Add tags...</span>
                                </div>
                                <div id="quest-tag-dropdown" class="tag-dropdown">
                                    <input id="questTagSearchInput" type="text" class="tag-search-input" placeholder="Search tags..." oninput="questTagSearchChanged()" />
                                    <div id="questTagOptions" class="tag-options"></div>
                                    <div class="tag-create" onclick="questTagCreateNew()">
                                        <span>Press enter to create</span>
                                        <span class="tag-create-label" id="questTagCreateLabel"></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="space-y-4">
                <div class="flex items-center justify-between">
                    <div class="text-xs uppercase tracking-[0.18em] text-gray-400 font-semibold">
                        Quest Description
                    </div>
                </div>
                <div class="rich-editor rounded-2xl border border-gray-200 overflow-hidden">
                    <div class="rich-toolbar">
                        <button type="button" class="rich-btn" onclick="questEditorExec('bold')">
                            <i class="bi bi-type-bold"></i>
                        </button>
                        <button type="button" class="rich-btn" onclick="questEditorExec('italic')">
                            <i class="bi bi-type-italic"></i>
                        </button>
                        <button type="button" class="rich-btn" onclick="questEditorExec('underline')">
                            <i class="bi bi-type-underline"></i>
                        </button>
                        <span class="mx-1 h-5 border-l border-gray-300"></span>
                        <button type="button" class="rich-btn" onclick="questEditorExec('insertUnorderedList')">
                            <i class="bi bi-list-ul"></i>
                        </button>
                        <button type="button" class="rich-btn" onclick="questEditorExec('insertOrderedList')">
                            <i class="bi bi-list-ol"></i>
                        </button>
                    </div>
                    <div id="questDescriptionEditor" class="rich-editor-body" contenteditable="true"
                        data-placeholder="Describe this quest in detail..."></div>
                </div>
            </div>
            <div class="flex justify-between items-center mt-6">
                <button type="button"
                    class="rounded-full px-4 py-2 text-xs md:text-sm font-semibold text-gray-600 bg-white border border-gray-200"
                    onclick="toggleQuestForm(false)">
                    Cancel
                </button>
                <button id="questSaveButton" type="button"
                    class="btn-dlg-blue rounded-full px-6 py-2 text-sm font-semibold shadow-md"
                    onclick="saveQuest()">
                    Create quest
                </button>
            </div>
        </div>

        <div class="grid md:grid-cols-[2fr,1.1fr] gap-6 items-start">
            <div class="space-y-4">
                <div class="flex items-center justify-between">
                    <h2 class="text-sm font-semibold text-gray-800">All quests</h2>
                </div>
                <div id="questTasksContainer" class="space-y-3"></div>
            </div>
            <div class="space-y-4">
                <div class="rounded-3xl border border-gray-200 bg-white shadow-sm p-4">
                    <div class="flex items-center justify-between mb-3">
                        <div>
                            <div class="text-[10px] uppercase tracking-[0.16em] text-gray-400 font-semibold">
                                Side Quest
                            </div>
                            <div class="text-xs text-gray-500">Quick personal todos</div>
                        </div>
                        <button type="button"
                            class="rounded-full px-3 py-1.5 text-[11px] font-semibold text-gray-700 bg-gray-100"
                            onclick="toggleSideQuestCreateDropdown()">
                            + Add
                        </button>
                    </div>
                    <div id="sideQuestCreateDropdown"
                        class="mt-3 rounded-2xl border border-gray-200 bg-gray-50 p-3 hidden">
                        <input id="sideQuestInput" type="text"
                            class="w-full rounded-xl border border-gray-200 px-3 py-2 text-xs md:text-sm text-gray-700 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-100"
                            placeholder="Write your side quest..." />
                        <div class="flex justify-end gap-2 mt-2">
                            <button type="button"
                                class="rounded-full px-3 py-1.5 text-[11px] font-semibold text-gray-600 bg-white border border-gray-200"
                                onclick="toggleSideQuestCreateDropdown(false)">
                                Cancel
                            </button>
                            <button type="button"
                                class="btn-dlg-red rounded-full px-4 py-1.5 text-[11px] font-semibold shadow-sm"
                                onclick="saveSideQuest()">
                                Save
                            </button>
                        </div>
                    </div>
                    <div id="sideQuestContainer" class="mt-3 space-y-2"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="questUniversalAlert"
        class="fixed inset-0 flex items-center justify-center bg-black/40 z-40 hidden">
        <div class="bg-white rounded-2xl shadow-xl px-6 py-5 max-w-sm w-full mx-4">
            <div id="questAlertTitle" class="text-sm font-semibold text-gray-900 mb-2"></div>
            <div id="questAlertMessage" class="text-xs text-gray-600 mb-4"></div>
            <div class="flex justify-end gap-2">
                <button type="button" id="questAlertCancelButton"
                    class="rounded-full px-4 py-1.5 text-xs font-semibold text-gray-600 bg-white border border-gray-200 hidden"
                    onclick="questAlertCancel()">
                    Cancel
                </button>
                <button type="button" id="questAlertOkButton"
                    class="rounded-full px-4 py-1.5 text-xs font-semibold text-gray-600 bg-white border border-gray-200"
                    onclick="questAlertOk()">
                    OK
                </button>
            </div>
        </div>
    </div>

    <script>
        var questDepartments = [];
        var questPositions = [];
        var questUsers = [];
        var questTasks = [];
        var questTasksById = {};
        var questRecurState = null;
        var questReminderState = null;
        var questTagsState = [];
        var questAlertOkHandler = null;
        var questAlertCancelHandler = null;

        function showQuestAlert(title, message) {
            var modal = document.getElementById('questUniversalAlert');
            var titleEl = document.getElementById('questAlertTitle');
            var messageEl = document.getElementById('questAlertMessage');
            var okBtn = document.getElementById('questAlertOkButton');
            var cancelBtn = document.getElementById('questAlertCancelButton');
            if (!modal || !titleEl || !messageEl || !okBtn || !cancelBtn) {
                alert((title ? title + ': ' : '') + message);
                return;
            }
            questAlertOkHandler = null;
            questAlertCancelHandler = null;
            cancelBtn.classList.add('hidden');
            okBtn.textContent = 'OK';
            titleEl.textContent = title;
            messageEl.textContent = message;
            modal.classList.remove('hidden');
        }

        function showQuestConfirm(title, message, onOk, onCancel) {
            var modal = document.getElementById('questUniversalAlert');
            var titleEl = document.getElementById('questAlertTitle');
            var messageEl = document.getElementById('questAlertMessage');
            var okBtn = document.getElementById('questAlertOkButton');
            var cancelBtn = document.getElementById('questAlertCancelButton');
            if (!modal || !titleEl || !messageEl || !okBtn || !cancelBtn) {
                var text = message;
                if (title) {
                    text = title + ': ' + message;
                }
                if (window.confirm(text)) {
                    if (typeof onOk === 'function') {
                        onOk();
                    }
                } else {
                    if (typeof onCancel === 'function') {
                        onCancel();
                    }
                }
                return;
            }
            questAlertOkHandler = typeof onOk === 'function' ? onOk : null;
            questAlertCancelHandler = typeof onCancel === 'function' ? onCancel : null;
            cancelBtn.classList.remove('hidden');
            okBtn.textContent = 'OK';
            titleEl.textContent = title;
            messageEl.textContent = message;
            modal.classList.remove('hidden');
        }

        function questAlertOk() {
            var modal = document.getElementById('questUniversalAlert');
            if (modal) {
                modal.classList.add('hidden');
            }
            if (questAlertOkHandler) {
                var handler = questAlertOkHandler;
                questAlertOkHandler = null;
                questAlertCancelHandler = null;
                handler();
            }
        }

        function questAlertCancel() {
            var modal = document.getElementById('questUniversalAlert');
            if (modal) {
                modal.classList.add('hidden');
            }
            if (questAlertCancelHandler) {
                var handler = questAlertCancelHandler;
                questAlertOkHandler = null;
                questAlertCancelHandler = null;
                handler();
            }
        }

        function toggleQuestForm(force) {
            var form = document.getElementById('questCreateForm');
            if (!form) return;
            var show = typeof force === 'boolean' ? force : form.classList.contains('hidden');
            if (show) {
                form.classList.remove('hidden');
            } else {
                form.classList.add('hidden');
            }
        }

        function toggleQuestHeaderMenu(event) {
            event.stopPropagation();
            var menu = document.getElementById('questHeaderMenu');
            if (!menu) return;
            menu.classList.toggle('hidden');
        }

        function questHeaderEdit() {}
        function questHeaderDelete() {}

        function toggleQuestDueDropdown() {
            var dd = document.getElementById('questDueDropdown');
            if (!dd) return;
            dd.classList.toggle('hidden');
        }

        function questDueQuickSelect(mode) {}
        function questDueGoToday() {}
        function questDueChangeMonth(delta) {}

        function toggleQuestRecurDropdown() {
            var dd = document.getElementById('questRecurDropdown');
            if (!dd) return;
            dd.classList.toggle('hidden');
        }

        function questRecurApplyPattern() {}
        function questRecurUpdateInterval() {}
        function questRecurUpdateUnit() {}
        function questRecurToggleWeekday(day) {}
        function questRecurUpdateMonthlyMode() {}
        function questRecurCancel() {}
        function questRecurSave() {}
        function questRecurGoToday() {}
        function questRecurChangeMonth(delta) {}

        function toggleQuestReminderDropdown() {
            var dd = document.getElementById('questReminderDropdown');
            if (!dd) return;
            dd.classList.toggle('hidden');
        }

        function questReminderQuickSelect(mode) {}
        function questReminderChangeMonth(delta) {}

        function toggleQuestNotifyDropdown() {
            var dd = document.getElementById('questNotifyDropdown');
            if (!dd) return;
            dd.classList.toggle('hidden');
        }

        function toggleSideQuestCreateDropdown(force) {
            var dd = document.getElementById('sideQuestCreateDropdown');
            if (!dd) return;
            var show = typeof force === 'boolean' ? force : dd.classList.contains('hidden');
            if (show) {
                dd.classList.remove('hidden');
            } else {
                dd.classList.add('hidden');
            }
        }

        function questTagFocusSearch() {
            var input = document.getElementById('questTagSearchInput');
            if (input) input.focus();
            var dd = document.getElementById('quest-tag-dropdown');
            if (dd) dd.style.display = 'block';
        }

        function questTagSearchChanged() {}
        function questTagCreateNew() {}

        function questEditorExec(cmd) {
            document.execCommand(cmd, false, null);
        }

        function loadQuestDepartments() {}
        function loadQuestPositions() {}
        function loadQuestUsers() {}
        function loadQuestTasks() {}
        function loadSideQuestTasks() {}
        function saveSideQuest() {}

        async function saveQuest() {
            var parentWin = window.parent;
            if (!parentWin || !parentWin.db || !parentWin.collection || !parentWin.addDoc || !parentWin.serverTimestamp) {
                showQuestAlert('Perhatian', 'Koneksi database tidak tersedia.');
                return;
            }
            var nameInput = document.getElementById('questNameInput');
            var name = nameInput ? String(nameInput.value || '').trim() : '';
            if (!name) {
                showQuestAlert('Perhatian', 'Quest belum memiliki nama.');
                return;
            }
            var dueInput = document.getElementById('questDueDate');
            var dueText = dueInput ? String(dueInput.value || '').trim() : '';
            if (!dueText) {
                showQuestAlert('Perhatian', 'task (atau Quest) tidak ada tanggalnya');
                return;
            }
            var recur = questRecurState;
            if (!recur) {
                showQuestAlert('Perhatian', 'Quest tidak berulang atau hanya di jalankan sekali');
                return;
            }
            var notifySelected = [];
            if (window.questNotifySelectedUsers && Array.isArray(window.questNotifySelectedUsers)) {
                notifySelected = window.questNotifySelectedUsers.slice();
            }
            if (notifySelected.length === 0) {
                showQuestAlert('Perhatian', 'Quest tidak dilaporkan ke siapa-siapa');
                return;
            }
            var pointInput = document.getElementById('questPointInput');
            var points = 0;
            if (pointInput && pointInput.value) {
                var p = parseFloat(pointInput.value);
                if (!isNaN(p) && p > 0) {
                    points = p;
                }
            }
            if (points === 0) {
                showQuestAlert('Perhatian', 'Quest tidak punya nilai');
                return;
            }
            var descEl = document.getElementById('questDescriptionEditor');
            var description = descEl ? descEl.innerHTML : '';
            var payload = {
                title: name,
                description: description,
                due_date: dueText,
                recur: recur,
                notify_to: notifySelected,
                points: points,
                status: 'Initiate'
            };
            payload.created_at = parentWin.serverTimestamp();
            try {
                await parentWin.addDoc(parentWin.collection(parentWin.db, 'tasks'), payload);
                if (typeof loadQuestTasks === 'function') {
                    loadQuestTasks();
                }
                toggleQuestForm(false);
                showQuestAlert('Sukses', 'Quest berhasil disimpan.');
            } catch (e) {
                showQuestAlert('Perhatian', 'Gagal menyimpan quest.');
            }
        }

        function questCloseDropdownIfOutside(event, dropdownId, useDisplay) {
            var dd = document.getElementById(dropdownId);
            if (!dd) return;
            var isVisible = useDisplay ? dd.style.display !== 'none' : !dd.classList.contains('hidden');
            if (!isVisible) return;
            if (!dd.contains(event.target)) {
                if (useDisplay) {
                    dd.style.display = 'none';
                } else {
                    dd.classList.add('hidden');
                }
            }
        }

        document.addEventListener('click', function (event) {
            var cardCheck = event.target.closest('.quest-card-check-btn');
            if (cardCheck) {
                var card = cardCheck.closest('.quest-card');
                if (card) {
                    var id = card.getAttribute('data-task-id');
                    if (id && typeof questToggleComplete === 'function') {
                        questToggleComplete(id);
                    }
                }
                return;
            }
            questCloseDropdownIfOutside(event, 'questDepartmentDropdown', false);
            questCloseDropdownIfOutside(event, 'questAssignDropdown', false);
            questCloseDropdownIfOutside(event, 'questDueDropdown', false);
            questCloseDropdownIfOutside(event, 'questRecurDropdown', false);
            questCloseDropdownIfOutside(event, 'questReminderDropdown', false);
            questCloseDropdownIfOutside(event, 'questPositionDropdown', false);
            questCloseDropdownIfOutside(event, 'questNotifyDropdown', false);
            questCloseDropdownIfOutside(event, 'quest-tag-dropdown', true);
            questCloseDropdownIfOutside(event, 'questHeaderMenu', false);
            questCloseDropdownIfOutside(event, 'sideQuestCreateDropdown', false);
        });

        window.addEventListener('load', function () {
            loadQuestDepartments();
            loadQuestPositions();
            loadQuestUsers();
            loadQuestTasks();
            loadSideQuestTasks();
        });
    </script>
</body>
</html>
