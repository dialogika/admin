<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>List - Dialogika</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="../assets/css/style.css" rel="stylesheet" />

    <style>
        .todo-row {
            position: relative;
            display: flex;
            align-items: center;
            padding: 12px;
            border-bottom: 1px solid #f1f5f9 !important;
            transition: 0.2s;
        }
        .todo-row:hover { background-color: #f8fafc; }
        .task-row-done .task-text-content { text-decoration: line-through; color: #94a3b8; }
        .new-tab-hint {
            opacity: 0;
            font-size: 0.7rem;
            color: #0B2B6A;
            font-weight: 700;
            margin-left: 10px;
            transition: 0.2s;
            text-transform: uppercase;
            cursor: pointer;
        }
        .todo-row:hover .new-tab-hint { opacity: 1; }
        .drag-handle-task { color: #cbd5e1; margin-right: 8px; cursor: grab; }
        .subtask-indent { margin-left: 40px; border-left: 2px solid #e2e8f0; }

        .main-list-card {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            padding: 40px;
            border: 1px solid #d1d5db;
        }
        .task-create-panel {
            background: #fff;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 25px;
            margin-top: 15px;
            display: none;
        }
        .task-title-large {
            font-size: 1.5rem;
            font-weight: 700;
            border: none;
            outline: none;
            width: 100%;
            margin-bottom: 15px;
        }

        .status-badge-main {
            padding: 4px 12px;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 700;
            text-transform: uppercase;
            color: white;
        }
        .status-drag-container {
            min-height: 50px;
            background: #f9fafb;
            border-radius: 8px;
            padding: 10px;
        }

        .meta-grid-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px 30px;
        }
        .ghost-input {
            border: 1px solid transparent;
            background: transparent;
            padding: 5px;
            width: 100%;
            border-radius: 4px;
        }
        .ghost-input:hover { background: #f1f5f9; }

        .priority-dropdown {
            position: relative;
            width: 100%;
        }
        .priority-trigger {
            display: flex;
            align-items: center;
            gap: 8px;
            width: 100%;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
            padding: 6px 10px;
            background: #f9fafb;
            cursor: pointer;
            font-size: 0.9rem;
        }
        .priority-trigger:hover {
            background: #eef2ff;
        }
        .priority-menu {
            position: absolute;
            top: 100%;
            left: 0;
            margin-top: 4px;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            box-shadow: 0 10px 20px rgba(15,23,42,0.15);
            padding: 6px 0;
            min-width: 180px;
            z-index: 1050;
            display: none;
        }
        .priority-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            cursor: pointer;
            font-size: 0.9rem;
        }
        .priority-item:hover {
            background: #f1f5f9;
        }
        .priority-flag {
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            color: white;
            font-size: 0.75rem;
        }
        .priority-flag-urgent { background: #ef4444; }
        .priority-flag-high { background: #f59e0b; }
        .priority-flag-normal { background: #3b82f6; }
        .priority-flag-low { background: #6b7280; }

        .comment-bubble {
            background: #f8fafc;
            border-radius: 12px;
            padding: 12px;
            border: 1px solid #e2e8f0;
        }
    </style>
</head>
<body>

    <nav class="top-bar">
        <div class="logo-center">
            <img src="https://www.dialogika.co/assets/img/logo.webp" alt="Dialogika" height="35">
        </div>
        <div class="d-flex align-items-center gap-3 ms-auto pe-4">
            <div class="text-end d-none d-lg-block lh-1">
                <span id="user-name-display" class="fw-bold small">Loading...</span>
            </div>
            <img id="user-photo-display" src="" class="profile-img" style="width:35px; height:35px; border-radius:50%">
        </div>
    </nav>

    <div class="dashboard-container">
        <main class="main-content w-100" style="margin-left:0; padding-top:100px">
            <div class="project-context-card mx-auto mb-4">
                <div class="ph-badge" id="projectBadge">Project</div>
                <div class="ph-crumb-container">
                    <a href="../home.html" class="ph-crumb-link"><i class="bi bi-house-fill"></i></a>
                    <i class="bi bi-chevron-right mx-2"></i>
                    <span id="projectNameHeader">Loading Project...</span>
                </div>
            </div>

            <div class="main-list-card">
                <div class="d-flex justify-content-between align-items-center mb-5">
                    <h1 class="fw-bold mb-0">All Lists</h1>
                    <span class="badge text-bg-success" id="allListDoneBadge" style="display:none">All Task Done</span>
                    <button class="btn btn-primary rounded-pill px-4" onclick="toggleNewListForm()">+ New List</button>
                </div>

                <div id="newListForm" class="border rounded-4 p-4 mb-4 shadow-sm" style="display:none">
                    <input type="text" id="inputListName" class="task-title-large" placeholder="List Name...">
                    <div id="inputListDesc" contenteditable="true" class="border p-3 rounded-3 mb-3" style="min-height:80px" data-placeholder="List description..."></div>
                    <div class="d-flex gap-2">
                        <button class="btn btn-success rounded-pill px-4" onclick="saveNewList()">Create List</button>
                        <button class="btn btn-light rounded-pill" onclick="toggleNewListForm()">Cancel</button>
                    </div>
                </div>

                <div id="loadingState" class="text-center py-5">
                    <div class="spinner-border text-primary"></div>
                </div>
                <div id="listsContainer"></div>
                <div id="emptyState" class="text-center text-muted py-5" style="display:none;">No lists yet.</div>
            </div>
        </main>
    </div>

    <div class="modal fade" id="descModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content rounded-4">
                <div class="modal-header border-0">
                    <h5 class="fw-bold" id="descModalTitle"></h5>
                    <button class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body pt-0" id="descModalBody"></div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="manageStatusModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content rounded-4">
                <div class="modal-header">
                    <h5>Manage Statuses</h5>
                    <button class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="activeListIdForStatus">
                    <div class="mb-3">
                        <label class="small fw-bold">ACTIVE STATUSES</label>
                        <div id="statusListContainer" class="status-drag-container"></div>
                    </div>
                    <div class="input-group">
                        <input type="text" id="newStatusNameInput" class="form-control" placeholder="New status name...">
                        <button class="btn btn-primary" onclick="addNewStatusToList()">Add</button>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-dark w-100 rounded-pill" onclick="saveStatusChanges()">Save Changes</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import {
            getFirestore, doc, collection, addDoc, updateDoc, deleteDoc,
            query, where, orderBy, onSnapshot, serverTimestamp, getDoc, getDocs, writeBatch
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDyzzEYbJkkl-N8snrQf14qvj8De4YliV0",
            authDomain: "pre-dialogika.firebaseapp.com",
            projectId: "pre-dialogika",
            storageBucket: "pre-dialogika.firebasestorage.app",
            messagingSenderId: "343771410480",
            appId: "1:343771410480:web:32881c9868522090237df5"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const urlParams = new URLSearchParams(window.location.search);
        const projectId = urlParams.get('id');
        let currentUser = null;
        let projectLists = [];
        let allTasks = [];
        const storedUser = JSON.parse(localStorage.getItem('userData') || 'null');

        onAuthStateChanged(auth, (user) => {
            if (user && projectId) {
                currentUser = user;
                setupUserUI(user);
                loadProjectHeader();
                listenToLists();
                listenToTasks();
            } else {
                window.location.href = "../index.html";
            }
        });

        function setupUserUI(user) {
            const nameDisplay = document.getElementById('user-name-display');
            const photoDisplay = document.getElementById('user-photo-display');

            const name = (storedUser && (storedUser.name || storedUser.Name)) || user.displayName || user.email || "User";
            const photo = (storedUser && (storedUser.photo || storedUser.Photo)) || user.photoURL || "https://i.pravatar.cc/300";

            if (nameDisplay) nameDisplay.innerText = name;
            if (photoDisplay) photoDisplay.src = photo;
        }

        async function loadProjectHeader() {
            const snap = await getDoc(doc(db, "projects", projectId));
            if (snap.exists()) {
                const data = snap.data();
                const nameEl = document.getElementById('projectNameHeader');
                const badgeEl = document.getElementById('projectBadge');
                if (nameEl) nameEl.innerText = data.name || "Untitled Project";
                if (badgeEl) badgeEl.innerText = data.department || "General";
            }
        }

        function listenToLists() {
            const q = query(collection(db, "projects", projectId, "lists"), orderBy("position", "asc"));
            onSnapshot(q, (snapshot) => {
                projectLists = [];
                snapshot.forEach(docSnap => projectLists.push({ id: docSnap.id, ...docSnap.data() }));
                renderUI();
            });
        }

        function listenToTasks() {
            const q = query(collection(db, "tasks"), where("project_id", "==", projectId));
            onSnapshot(q, (snapshot) => {
                allTasks = [];
                snapshot.forEach(docSnap => allTasks.push({ id: docSnap.id, ...docSnap.data() }));
                allTasks.sort((a, b) => {
                    const pa = typeof a.position === "number" ? a.position : 0;
                    const pb = typeof b.position === "number" ? b.position : 0;
                    return pa - pb;
                });
                renderUI();
            }, (error) => {
                console.error("Failed to listen tasks", error);
                alert("Gagal mengambil data tasks: " + error.message);
            });
        }

        function renderUI() {
            const container = document.getElementById('listsContainer');
            const loadingState = document.getElementById('loadingState');
            const emptyState = document.getElementById('emptyState');
            const allDoneBadge = document.getElementById('allListDoneBadge');

            if (loadingState) loadingState.style.display = 'none';
            if (!container) return;

            container.innerHTML = '';

            const totalTasks = allTasks.length;
            const completedTasks = allTasks.filter(t => t.status === 'Complete').length;
            if (allDoneBadge) {
                allDoneBadge.style.display = totalTasks > 0 && completedTasks === totalTasks ? 'inline-block' : 'none';
            }

            if (projectLists.length === 0) {
                if (emptyState) emptyState.style.display = 'block';
                return;
            }
            if (emptyState) emptyState.style.display = 'none';

            projectLists.forEach(list => {
                const listTasks = allTasks.filter(t => t.list_id === list.id && !t.parent_task_id);

                const tasksHtml = listTasks.map(t => {
                    const subtasks = allTasks.filter(st => st.parent_task_id === t.id);
                    return renderTaskRow(t, subtasks);
                }).join('');

                const rawDesc = (list.description || "").replace(/<[^>]+>/g, " ");
                const words = rawDesc.trim().split(/\s+/).filter(Boolean);
                const truncatedDesc = words.length > 8
                    ? words.slice(0, 8).join(" ") + `... <a href="#" onclick="showFullDesc('${list.id}'); return false;">more...</a>`
                    : rawDesc;

                const html = `
                    <div class="mb-5 bg-white p-4 rounded-4 border shadow-sm" id="list-${list.id}">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h2 class="h4 fw-bold mb-1 text-dark">${list.name}</h2>
                                <div class="small text-muted mb-3">${truncatedDesc || ""}</div>
                            </div>
                            <div class="dropdown">
                                <button class="btn btn-sm btn-light border-0" data-bs-toggle="dropdown">
                                    <i class="bi bi-three-dots-vertical"></i>
                                </button>
                                <ul class="dropdown-menu dropdown-menu-end">
                                    <li><a class="dropdown-item" href="#" onclick="openStatusManager('${list.id}'); return false;">Manage statuses</a></li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li><a class="dropdown-item text-danger" href="#" onclick="deleteList('${list.id}'); return false;">Delete list</a></li>
                                </ul>
                            </div>
                        </div>

                        <div class="d-flex gap-2 mb-3 align-items-center">
                            ${(list.statuses || []).map(s => `<span class="status-badge-main" style="background:${s.color || '#0B2B6A'}">${s.name}</span>`).join('<i class="bi bi-chevron-right small text-muted"></i>')}
                            <i class="bi bi-plus-circle text-muted cursor-pointer" onclick="openStatusManager('${list.id}')"></i>
                        </div>

                        <div class="task-items-container" id="items-${list.id}">${tasksHtml}</div>

                        <button class="btn btn-sm btn-outline-secondary rounded-pill mt-3" onclick="showTaskForm('${list.id}')">+ Add to-do</button>

                        <div id="form-add-${list.id}" class="task-create-panel">
                            <input type="text" id="title-${list.id}" class="task-title-large" placeholder="Task Name">

                            <div class="meta-grid-container mb-3">
                                <div class="d-flex flex-column gap-2">
                                    <div class="d-flex align-items-center gap-2">
                                        <span class="text-muted small">Status</span>
                                    </div>
                                    <div class="d-flex align-items-center gap-2">
                                        <i class="bi bi-record-circle text-muted"></i>
                                        <select id="status-${list.id}" class="ghost-input">
                                            ${(list.statuses || [{ name: 'Initiate' }]).map(s => `<option value="${s.name}">${s.name}</option>`).join('')}
                                        </select>
                                    </div>
                                </div>

                                <div class="d-flex flex-column gap-2">
                                    <div class="d-flex align-items-center gap-2">
                                        <span class="text-muted small">Priority</span>
                                    </div>
                                    <div class="priority-dropdown" id="priority-wrap-${list.id}">
                                        <button type="button" class="priority-trigger" onclick="togglePriorityMenu('${list.id}')">
                                            <span class="priority-flag priority-flag-normal">
                                                <i class="bi bi-flag-fill"></i>
                                            </span>
                                            <span id="priority-label-${list.id}">Normal</span>
                                            <i class="bi bi-chevron-down ms-auto text-muted small"></i>
                                        </button>
                                        <div class="priority-menu" id="priority-menu-${list.id}">
                                            <div class="priority-item" data-value="urgent" onclick="selectPriority('${list.id}','urgent')">
                                                <span class="priority-flag priority-flag-urgent"><i class="bi bi-flag-fill"></i></span>
                                                <span>Urgent</span>
                                            </div>
                                            <div class="priority-item" data-value="high" onclick="selectPriority('${list.id}','high')">
                                                <span class="priority-flag priority-flag-high"><i class="bi bi-flag-fill"></i></span>
                                                <span>High</span>
                                            </div>
                                            <div class="priority-item" data-value="normal" onclick="selectPriority('${list.id}','normal')">
                                                <span class="priority-flag priority-flag-normal"><i class="bi bi-flag-fill"></i></span>
                                                <span>Normal</span>
                                            </div>
                                            <div class="priority-item" data-value="low" onclick="selectPriority('${list.id}','low')">
                                                <span class="priority-flag priority-flag-low"><i class="bi bi-flag-fill"></i></span>
                                                <span>Low</span>
                                            </div>
                                        </div>
                                        <input type="hidden" id="priority-${list.id}" value="normal">
                                    </div>
                                </div>

                                <div class="d-flex flex-column gap-2">
                                    <div class="d-flex align-items-center gap-2">
                                        <span class="text-muted small">Assign to</span>
                                    </div>
                                    <div class="d-flex align-items-center gap-2">
                                        <i class="bi bi-person text-muted"></i>
                                        <input type="text" id="assign-${list.id}" class="ghost-input" placeholder="User ID or email">
                                    </div>
                                </div>

                                <div class="d-flex flex-column gap-2">
                                    <div class="d-flex align-items-center gap-2">
                                        <span class="text-muted small">Notify to</span>
                                    </div>
                                    <div class="d-flex align-items-center gap-2">
                                        <i class="bi bi-bell text-muted"></i>
                                        <input type="text" id="notify-${list.id}" class="ghost-input" placeholder="User ID or email">
                                    </div>
                                </div>

                                <div class="d-flex flex-column gap-2">
                                    <div class="d-flex align-items-center gap-2">
                                        <span class="text-muted small">Dates</span>
                                    </div>
                                    <div class="d-flex align-items-center gap-2">
                                        <i class="bi bi-calendar text-muted"></i>
                                        <input type="date" id="start-${list.id}" class="ghost-input">
                                        <span class="text-muted small">to</span>
                                        <input type="date" id="due-${list.id}" class="ghost-input">
                                    </div>
                                </div>

                                <div class="d-flex flex-column gap-2">
                                    <div class="d-flex align-items-center gap-2">
                                        <span class="text-muted small">Task point</span>
                                    </div>
                                    <div class="d-flex align-items-center gap-2">
                                        <i class="bi bi-star text-muted"></i>
                                        <input type="number" id="points-${list.id}" class="ghost-input" min="0" placeholder="Empty">
                                    </div>
                                </div>

                                <div class="d-flex flex-column gap-2">
                                    <div class="d-flex align-items-center gap-2">
                                        <span class="text-muted small">Track time</span>
                                    </div>
                                    <div class="d-flex align-items-center gap-2">
                                        <i class="bi bi-stopwatch text-muted"></i>
                                        <span class="text-muted small" id="track-label-${list.id}">Empty</span>
                                        <button type="button" class="btn btn-sm btn-outline-secondary rounded-pill px-3" disabled>Start</button>
                                    </div>
                                </div>

                                <div class="d-flex flex-column gap-2">
                                    <div class="d-flex align-items-center gap-2">
                                        <span class="text-muted small">Tags</span>
                                    </div>
                                    <div class="d-flex align-items-center gap-2">
                                        <i class="bi bi-tag text-muted"></i>
                                        <input type="text" id="tags-${list.id}" class="ghost-input" placeholder="tag-a, tag-b">
                                    </div>
                                </div>
                            </div>

                            <div class="mt-3 border rounded-3 p-2" id="desc-${list.id}" contenteditable="true" style="min-height:80px" data-placeholder="Task description or notes..."></div>
                            <div class="mt-3 d-flex gap-2 justify-content-end">
                                <button class="btn btn-primary rounded-pill px-4" onclick="saveTask('${list.id}')">Add to-do</button>
                                <button class="btn btn-light rounded-pill px-4" onclick="hideTaskForm('${list.id}')">Cancel</button>
                            </div>
                        </div>
                    </div>
                `;

                container.insertAdjacentHTML('beforeend', html);
                initTaskSortable(list.id);
            });
        }

        function renderTaskRow(t, subtasks) {
            let html = `
                <div class="todo-row ${t.status === 'Complete' ? 'task-row-done' : ''}" id="task-${t.id}">
                    <i class="bi bi-list drag-handle-task"></i>
                    <input type="checkbox" class="form-check-input me-2" ${t.status === 'Complete' ? 'checked' : ''} onclick="toggleDone('${t.id}', this.checked)">
                    <div class="flex-grow-1 task-text-content">
                        ${t.title}
                        <span class="new-tab-hint" onclick="window.location.href='item-details.html?id=${t.id}'">Open Task</span>
                    </div>
                    <span class="badge bg-light text-dark border small">${t.status}</span>
                </div>
            `;

            subtasks.forEach(st => {
                html += `
                    <div class="todo-row subtask-indent ${st.status === 'Complete' ? 'task-row-done' : ''}" id="task-${st.id}">
                        <input type="checkbox" class="form-check-input me-2" ${st.status === 'Complete' ? 'checked' : ''} onclick="toggleDone('${st.id}', this.checked)">
                        <div class="small task-text-content">${st.title}</div>
                    </div>
                `;
            });

            return html;
        }

        window.saveNewList = async () => {
            const name = document.getElementById('inputListName').value.trim();
            const desc = document.getElementById('inputListDesc').innerHTML;
            if (!name) return;

            await addDoc(collection(db, "projects", projectId, "lists"), {
                name: name,
                description: desc,
                position: projectLists.length,
                statuses: [
                    { name: "Initiate", color: "#64748b", type: "not_started", position: 0 },
                    { name: "Complete", color: "#108a00", type: "done", position: 1 }
                ],
                created_at: serverTimestamp()
            });

            document.getElementById('inputListName').value = "";
            document.getElementById('inputListDesc').innerHTML = "";
            toggleNewListForm();
        };

        window.saveTask = async (listId) => {
            const titleEl = document.getElementById(`title-${listId}`);
            if (!titleEl) return;
            const title = titleEl.value.trim();
            if (!title) return;

            const existingForList = allTasks.filter(t => t.list_id === listId);

            const statusEl = document.getElementById(`status-${listId}`);
            const priorityEl = document.getElementById(`priority-${listId}`);
            const startEl = document.getElementById(`start-${listId}`);
            const dueEl = document.getElementById(`due-${listId}`);
            const pointsEl = document.getElementById(`points-${listId}`);
            const assignEl = document.getElementById(`assign-${listId}`);
            const notifyEl = document.getElementById(`notify-${listId}`);
            const tagsEl = document.getElementById(`tags-${listId}`);

            const tagsValue = tagsEl ? tagsEl.value : "";
            const tagList = tagsValue
                ? tagsValue.split(",").map(t => t.trim()).filter(Boolean)
                : [];

            const payload = {
                project_id: projectId,
                list_id: listId,
                title: title,
                description: document.getElementById(`desc-${listId}`).innerHTML || "",
                status: statusEl ? (statusEl.value || "Initiate") : "Initiate",
                priority: priorityEl ? (priorityEl.value || "normal") : "normal",
                start_date: startEl ? (startEl.value || "") : "",
                due_date: dueEl ? (dueEl.value || "") : "",
                points: pointsEl && pointsEl.value ? Number(pointsEl.value) || 0 : 0,
                assign_to: assignEl ? (assignEl.value || "") : "",
                notify_to: notifyEl ? (notifyEl.value || "") : "",
                tags: tagList,
                position: existingForList.length,
                created_at: serverTimestamp(),
                created_by: currentUser ? currentUser.uid : ""
            };

            try {
                await addDoc(collection(db, "tasks"), payload);
            } catch (e) {
                console.error("Failed to add task", e, payload);
                alert("Gagal menyimpan task ke Firebase: " + e.message);
                return;
            }

            titleEl.value = "";
            document.getElementById(`desc-${listId}`).innerHTML = "";
            if (startEl) startEl.value = "";
            if (dueEl) dueEl.value = "";
            if (pointsEl) pointsEl.value = "";
            if (assignEl) assignEl.value = "";
            if (notifyEl) notifyEl.value = "";
            if (tagsEl) tagsEl.value = "";
            hideTaskForm(listId);
        };

        window.togglePriorityMenu = (lid) => {
            const menu = document.getElementById(`priority-menu-${lid}`);
            if (!menu) return;
            menu.style.display = menu.style.display === "block" ? "none" : "block";
        };

        window.selectPriority = (lid, value) => {
            const hidden = document.getElementById(`priority-${lid}`);
            const label = document.getElementById(`priority-label-${lid}`);
            const flag = document.querySelector(`#priority-wrap-${lid} .priority-flag`);
            if (!hidden || !label || !flag) return;

            hidden.value = value;

            let text = "Normal";
            let className = "priority-flag-normal";
            if (value === "urgent") {
                text = "Urgent";
                className = "priority-flag-urgent";
            } else if (value === "high") {
                text = "High";
                className = "priority-flag-high";
            } else if (value === "low") {
                text = "Low";
                className = "priority-flag-low";
            }

            label.innerText = text;

            flag.classList.remove("priority-flag-urgent", "priority-flag-high", "priority-flag-normal", "priority-flag-low");
            flag.classList.add(className);

            const menu = document.getElementById(`priority-menu-${lid}`);
            if (menu) menu.style.display = "none";
        };

        window.toggleDone = async (id, isChecked) => {
            await updateDoc(doc(db, "tasks", id), {
                status: isChecked ? "Complete" : "Initiate"
            });
        };

        window.openStatusManager = (lid) => {
            const list = projectLists.find(l => l.id === lid);
            if (!list) return;

            document.getElementById('activeListIdForStatus').value = lid;
            const container = document.getElementById('statusListContainer');
            container.innerHTML = (list.statuses || []).map(s => `
                <div class="d-flex align-items-center gap-2 bg-white border p-2 mb-2 rounded shadow-sm" data-name="${s.name}" data-color="${s.color || '#0B2B6A'}">
                    <i class="bi bi-grip-vertical"></i>
                    <div style="width:15px; height:15px; border-radius:50%; background:${s.color || '#0B2B6A'}"></div>
                    <span class="fw-bold small flex-grow-1">${s.name}</span>
                    <button class="btn btn-sm btn-link text-danger p-0" onclick="this.closest('.d-flex').remove()">Delete</button>
                </div>
            `).join('');

            new Sortable(container, { animation: 150 });
            new bootstrap.Modal(document.getElementById('manageStatusModal')).show();
        };

        window.addNewStatusToList = () => {
            const nameInput = document.getElementById('newStatusNameInput');
            const name = nameInput.value.trim();
            if (!name) return;

            const container = document.getElementById('statusListContainer');
            const color = "#0B2B6A";
            const div = document.createElement('div');
            div.className = "d-flex align-items-center gap-2 bg-white border p-2 mb-2 rounded shadow-sm";
            div.dataset.name = name;
            div.dataset.color = color;
            div.innerHTML = `
                <i class="bi bi-grip-vertical"></i>
                <div style="width:15px; height:15px; border-radius:50%; background:${color}"></div>
                <span class="fw-bold small flex-grow-1">${name}</span>
                <button class="btn btn-sm btn-link text-danger p-0" onclick="this.closest('.d-flex').remove()">Delete</button>
            `;
            container.appendChild(div);
            nameInput.value = "";
        };

        window.saveStatusChanges = async () => {
            const lid = document.getElementById('activeListIdForStatus').value;
            if (!lid) return;

            const items = document.querySelectorAll('#statusListContainer > div');
            const newStatuses = Array.from(items).map((el, index) => ({
                name: el.dataset.name,
                color: el.dataset.color,
                position: index
            }));

            await updateDoc(doc(db, "projects", projectId, "lists", lid), {
                statuses: newStatuses
            });

            const modal = bootstrap.Modal.getInstance(document.getElementById('manageStatusModal'));
            if (modal) modal.hide();
        };

        window.deleteList = async (lid) => {
            if (!confirm("Delete this list and its tasks?")) return;

            await deleteDoc(doc(db, "projects", projectId, "lists", lid));

            const q = query(collection(db, "tasks"), where("list_id", "==", lid));
            const snap = await getDocs(q);
            const batch = writeBatch(db);
            snap.forEach(d => batch.delete(d.ref));
            await batch.commit();
        };

        window.toggleNewListForm = () => {
            const f = document.getElementById('newListForm');
            if (!f) return;
            f.style.display = f.style.display === 'none' ? 'block' : 'none';
        };

        window.showTaskForm = (lid) => {
            const el = document.getElementById(`form-add-${lid}`);
            if (el) el.style.display = 'block';
        };

        window.hideTaskForm = (lid) => {
            const el = document.getElementById(`form-add-${lid}`);
            if (el) el.style.display = 'none';
        };

        window.showFullDesc = (lid) => {
            const list = projectLists.find(l => l.id === lid);
            if (!list) return;
            const titleEl = document.getElementById('descModalTitle');
            const bodyEl = document.getElementById('descModalBody');
            if (titleEl) titleEl.innerText = list.name;
            if (bodyEl) bodyEl.innerHTML = list.description || "";
            new bootstrap.Modal(document.getElementById('descModal')).show();
        };

        function initTaskSortable(lid) {
            const el = document.getElementById(`items-${lid}`);
            if (!el) return;
            new Sortable(el, {
                handle: '.drag-handle-task',
                animation: 150,
                onEnd: async function () {
                    const rows = el.querySelectorAll('.todo-row');
                    rows.forEach(async (row, index) => {
                        const taskId = row.id.replace('task-', '');
                        await updateDoc(doc(db, "tasks", taskId), { position: index });
                    });
                }
            });
        }
    </script>
</body>
</html>
