<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Task Detail</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link href="../assets/css/style.css" rel="stylesheet" />
    <style>
        body { background-color: #e5e7eb; }
        .main-content { margin-left: 290px; width: calc(100% - 290px); padding: 40px; min-height: 100vh; }
        @media (max-width: 991px) { .main-content { margin-left: 0; width: 100%; padding: 20px; } }
        
        .main-card {
            max-width: 900px; margin: 0 auto; background: white; border-radius: 16px;
            padding: 50px; box-shadow: 0 10px 40px rgba(0,0,0,0.05); border: 1px solid #d1d5db;
        }
        .task-checkbox-lg {
            width: 45px; height: 45px; border: 3px solid #d1d5db; border-radius: 12px;
            display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.2s;
        }
        .task-checkbox-lg:hover { border-color: var(--dlg-blue); }
        .task-checkbox-lg.checked { background-color: #10b981; border-color: #10b981; color: white; }
    </style>
</head>
<body>

    <nav class="top-bar">
        <!-- (Isi Nav Bar sama) -->
        <div class="logo-center"><img src="https://www.dialogika.co/assets/img/logo.webp" height="35"></div>
    </nav>

    <div class="dashboard-container">
        <aside class="sidebar" id="sidebarNav">
             <!-- (Isi Sidebar sama) -->
             <div class="sidebar-scroll-wrapper">
                <a href="../home.html" class="sidebar-link"><i class="bi bi-columns-gap"></i> Dashboard</a>
             </div>
        </aside>

        <main class="main-content">
            
            <!-- BREADCRUMB SIMPLE -->
            <div class="mb-4 text-muted small">
                <a href="../home.html" class="text-decoration-none text-muted">Home</a> /
                <a href="#" id="linkProject" class="text-decoration-none text-muted">Project</a> /
                <a href="#" id="linkList" class="text-decoration-none text-muted">List</a> /
                <span class="fw-bold text-dark">Task Detail</span>
            </div>

            <div class="main-card">
                
                <!-- HEADER TASK -->
                <div class="d-flex align-items-start gap-3 mb-4">
                    <!-- Checkbox Besar -->
                    <div id="bigCheckbox" class="task-checkbox-lg flex-shrink-0" onclick="toggleTaskStatus()">
                        <i class="bi bi-check-lg fs-3 d-none" id="checkIcon"></i>
                    </div>
                    <div>
                        <h1 class="fw-bold mb-1" style="font-size: 2rem;" id="taskTitle">Loading...</h1>
                        <p class="text-muted small">Added by <span class="fw-bold">User Demo</span></p>
                    </div>
                </div>

                <!-- METADATA FORM (Static for MVP) -->
                <div class="row mb-3 align-items-center">
                    <div class="col-md-3 text-md-end fw-bold text-secondary">Assigned to</div>
                    <div class="col-md-9 border-bottom border-dashed pb-1 text-muted">Unassigned</div>
                </div>
                <div class="row mb-5 align-items-start">
                    <div class="col-md-3 text-md-end fw-bold text-secondary pt-1">Notes</div>
                    <div class="col-md-9 border-bottom border-dashed pb-1 text-muted">No additional notes.</div>
                </div>

                <hr class="opacity-10 my-5">

                <!-- COMMENT SECTION -->
                <div id="taskComments" class="d-flex flex-column gap-3 mb-4">
                    <!-- Comments injected here -->
                </div>

                <!-- COMMENT EDITOR -->
                <div class="d-flex gap-3">
                    <div class="rounded-circle bg-primary text-white d-flex align-items-center justify-content-center fw-bold flex-shrink-0" style="width:45px; height:45px;">RA</div>
                    <div class="w-100 border rounded-3 overflow-hidden">
                        <div id="taskCommentInput" class="p-3 bg-light text-muted" contenteditable="true" style="min-height:100px; outline:none;">Add a comment here...</div>
                        <div class="p-2 bg-white border-top text-end">
                            <button class="btn btn-success rounded-pill px-4 btn-sm fw-bold" onclick="postTaskComment()">Comment</button>
                        </div>
                    </div>
                </div>

                <!-- SUBSCRIBERS -->
                <div class="mt-5 pt-4 border-top">
                    <h6 class="fw-bold">Subscribers</h6>
                    <p class="small text-muted mb-3">People notified on this task.</p>
                    <div class="d-flex align-items-center gap-2">
                        <div class="rounded-circle bg-primary text-white d-flex align-items-center justify-content-center fw-bold" style="width:30px; height:30px; font-size:0.7rem;">RA</div>
                        <button class="btn btn-light border rounded-pill px-3 py-1 btn-sm">Add/remove people...</button>
                    </div>
                </div>

            </div>
        </main>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const API_URL = 'GANTI_DENGAN_URL_DEPLOY_TERBARU_ANDA'; // <--- UPDATE INI

        const urlParams = new URLSearchParams(window.location.search);
        const taskId = urlParams.get('taskId');
        const projectId = urlParams.get('projectId');
        let currentListId = null;

        document.addEventListener("DOMContentLoaded", function() {
            if(!taskId || !projectId) return alert("Missing Parameters");
            
            // Set basic links
            document.getElementById('linkProject').href = `../project/project.html?id=${projectId}`;
            
            fetchTaskData();
        });

        function fetchTaskData() {
            fetch(`${API_URL}?action=getProjectData&id=${projectId}`)
            .then(res => res.json())
            .then(response => {
                if(response.status === 'success') {
                    const data = response.data;
                    
                    document.getElementById('linkProject').innerText = data.project.name;

                    // Cari Task ini ada di list mana
                    let foundTask = null;
                    data.lists.forEach(list => {
                        const t = list.tasks.find(x => x.id === taskId);
                        if(t) {
                            foundTask = t;
                            currentListId = list.id; // Simpan List ID untuk comment
                            document.getElementById('linkList').innerText = list.name;
                            document.getElementById('linkList').href = `list-detail.html?listId=${list.id}&projectId=${projectId}`;
                        }
                    });

                    if(foundTask) {
                        document.getElementById('taskTitle').innerText = foundTask.title;
                        // Update Checkbox UI
                        const isDone = ['done', 'true'].includes(foundTask.status);
                        const box = document.getElementById('bigCheckbox');
                        const icon = document.getElementById('checkIcon');
                        if(isDone) {
                            box.classList.add('checked');
                            icon.classList.remove('d-none');
                        }
                        
                        // Render Comments (Filter by taskId)
                        const tComments = data.comments ? data.comments.filter(c => c.taskId === taskId) : [];
                        renderComments(tComments);
                    }
                }
            });
        }

        function renderComments(comments) {
            const container = document.getElementById('taskComments');
            container.innerHTML = '';
            comments.forEach(c => {
                const html = `
                    <div class="d-flex gap-3">
                        <div class="rounded-circle bg-secondary text-white d-flex align-items-center justify-content-center fw-bold flex-shrink-0" style="width:40px; height:40px;">U</div>
                        <div class="bg-white border rounded p-3 w-100">
                            <div class="d-flex justify-content-between mb-1">
                                <strong class="small">User Demo</strong>
                                <small class="text-muted">${new Date(c.date).toLocaleDateString()}</small>
                            </div>
                            <div>${c.text}</div>
                        </div>
                    </div>`;
                container.insertAdjacentHTML('beforeend', html);
            });
        }

        function postTaskComment() {
            const input = document.getElementById('taskCommentInput');
            const text = input.innerText;
            if(text.trim() === '' || text.includes('Add a comment')) return;

            input.innerText = "Posting...";
            
            fetch(API_URL, {
                method: 'POST',
                body: JSON.stringify({
                    action: 'createComment',
                    projectId: projectId,
                    taskId: taskId, // Kirim Task ID
                    listId: currentListId, // Optional, biar lengkap datanya
                    text: text
                })
            }).then(res => res.json()).then(resp => {
                input.innerText = "Add a comment here...";
                fetchTaskData();
            });
        }

        function toggleTaskStatus() {
            // Visual Toggle Only for now (Backend update logic can be added later)
            const box = document.getElementById('bigCheckbox');
            const icon = document.getElementById('checkIcon');
            box.classList.toggle('checked');
            icon.classList.toggle('d-none');
        }
    </script>
</body>
</html>
